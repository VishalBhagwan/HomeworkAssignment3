@{
    ViewBag.Title = "Inventory Reports";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var stockItems = ViewBag.StockItems as List<HomeworkAssignment3.Controllers.StockItemReport> ?? new List<HomeworkAssignment3.Controllers.StockItemReport>();
    var popularProducts = ViewBag.PopularProducts as List<HomeworkAssignment3.Controllers.PopularProductReport> ?? new List<HomeworkAssignment3.Controllers.PopularProductReport>();
    var savedReports = ViewBag.SavedReports as List<HomeworkAssignment3.Controllers.SavedReport> ?? new List<HomeworkAssignment3.Controllers.SavedReport>();
}

<!-- Add Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container mt-4">
    <h2 class="text-center mb-4">📊 Inventory Reports & Analytics</h2>

    <!-- Display messages -->
    @if (ViewBag.Error != null)
    {
        <div class="alert alert-warning">
            @ViewBag.Error
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">
            @TempData["Error"]
        </div>
    }

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">
            @TempData["Success"]
        </div>
    }

    @if (TempData["Warning"] != null)
    {
        <div class="alert alert-warning">
            @TempData["Warning"]
        </div>
    }

    <!-- Export reports -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">💾 Export Reports</h5>
        </div>
        <div class="card-body">
            @using (Html.BeginForm("ExportReport", "Reports", FormMethod.Post, new { @class = "row g-3" }))
            {
                @Html.AntiForgeryToken()
                <div class="col-md-4">
                    <label class="form-label fw-bold">Report Type</label>
                    <select name="reportType" class="form-select" required>
                        <option value="stock">Stock Items Report</option>
                        <option value="popular">Popular Products Report</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">File Name</label>
                    <input type="text" name="fileName" class="form-control" placeholder="Enter file name" required>
                    <small class="form-text text-muted">Don't include file extension</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">File Type</label>
                    <select name="fileType" class="form-select" required>
                        <option value="csv">CSV File</option>
                        <option value="pdf">PDF Document</option>
                        <option value="excel">Excel Spreadsheet</option>
                    </select>
                    <small class="form-text text-muted">All formats contain the same data</small>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-success w-100">
                        📥 Export Report
                    </button>
                </div>
            }
        </div>
    </div>

    <!-- Graphical Dashboard Section -->
    <div class="row mb-4">
        <!-- Summary Statistics Cards -->
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-primary h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Unsold Stock</h5>
                            <h3 class="card-text">@ViewBag.TotalProductsInStock</h3>
                            <p class="card-text">Products in inventory</p>
                        </div>
                        <div class="display-4">📦</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-success h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Stock Value</h5>
                            <h3 class="card-text">R @(ViewBag.TotalStockValue?.ToString("N2") ?? "0.00")</h3>
                            <p class="card-text">Total inventory value</p>
                        </div>
                        <div class="display-4">💰</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-info h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Top Seller</h5>
                            <h6 class="card-text">@ViewBag.TopSellingProduct</h6>
                            <p class="card-text">Most popular product</p>
                        </div>
                        <div class="display-4">🏆</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-warning h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Total Orders</h5>
                            <h3 class="card-text">@ViewBag.TotalOrders</h3>
                            <p class="card-text">Units sold</p>
                        </div>
                        <div class="display-4">📈</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <!-- Stock by Category Chart -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">📊 Stock Distribution by Category</h5>
                </div>
                <div class="card-body">
                    <canvas id="stockByCategoryChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Top Products Chart -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">🏆 Top Selling Products</h5>
                </div>
                <div class="card-body">
                    <canvas id="topProductsChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Charts -->
    <div class="row mb-4">
        <!-- Brand Performance Chart -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">🏷️ Brand Performance</h5>
                </div>
                <div class="card-body">
                    <canvas id="brandPerformanceChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Price vs Stock Analysis -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">⚖️ Price vs Stock Analysis</h5>
                </div>
                <div class="card-body">
                    <canvas id="priceStockChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Tables Section -->
    <div class="row">
        <!-- Stock items report -->
        <div class="col-lg-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">📦 Stock Items Report</h5>
                    <small class="mb-0">Products available in store but not yet sold</small>
                </div>
                <div class="card-body">
                    @if (stockItems.Any())
                    {
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-striped table-bordered table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Product ID</th>
                                        <th>Product Name</th>
                                        <th>Brand</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                        <th>Stock Qty</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in stockItems)
                                    {
                                        <tr>
                                            <td>@item.ProductId</td>
                                            <td>@item.ProductName</td>
                                            <td>@item.BrandName</td>
                                            <td>@item.CategoryName</td>
                                            <td>R @item.ListPrice.ToString("N2")</td>
                                            <td>
                                                <span class="badge @(item.QuantityInStock > 5 ? "bg-success" : "bg-warning")">
                                                    @item.QuantityInStock
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <strong>Report Purpose:</strong> Identifies products that are available in inventory but haven't been sold yet.
                                This helps in managing stock levels and identifying slow-moving items.
                            </small>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-success text-center">
                            <h5>🎉 Excellent Stock Management!</h5>
                            <p>All products in inventory have been sold at least once.</p>
                            <small class="text-muted">No unsold products found in stock.</small>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Popular products report -->
        <div class="col-lg-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">🏆 Popular Products Report</h5>
                    <small class="mb-0">Most frequently ordered products</small>
                </div>
                <div class="card-body">
                    @if (popularProducts.Any())
                    {
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-striped table-bordered table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Product Name</th>
                                        <th>Brand</th>
                                        <th>Category</th>
                                        <th>Orders</th>
                                        <th>Revenue</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in popularProducts)
                                    {
                                        <tr>
                                            <td>@item.ProductName</td>
                                            <td>@item.BrandName</td>
                                            <td>@item.CategoryName</td>
                                            <td>
                                                <span class="badge @(item.OrderCount > 15 ? "bg-danger" : item.OrderCount > 10 ? "bg-warning" : "bg-info")">
                                                    @item.OrderCount
                                                </span>
                                            </td>
                                            <td>R @item.TotalRevenue.ToString("N2")</td>
                                            <td>
                                                @if (item.OrderCount > 15)
                                                {
                                                    <span class="badge bg-danger">High Demand</span>
                                                }
                                                else if (item.OrderCount > 10)
                                                {
                                                    <span class="badge bg-warning">Medium Demand</span>
                                                }
                                                else if (item.OrderCount > 5)
                                                {
                                                    <span class="badge bg-info">Low Demand</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Minimal</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <strong>Report Purpose:</strong> Shows the most frequently ordered products to help identify:
                                <ul class="mb-0">
                                    <li>Products that need frequent restocking</li>
                                    <li>Slow-moving items that may need promotion</li>
                                    <li>Popular brands and categories for inventory planning</li>
                                </ul>
                            </small>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info text-center">
                            <h5>No Sales Data Available</h5>
                            <p>There are no product orders in the system yet.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Document archive section -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">📁 Document Archive</h5>
                    <small class="mb-0">Previously saved reports</small>
                </div>
                <div class="card-body">
                    @if (savedReports.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>File Name</th>
                                        <th>Type</th>
                                        <th>Created Date</th>
                                        <th>Size</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var report in savedReports)
                                    {
                                        <tr>
                                            <td>@report.FileName</td>
                                            <td>
                                                <span class="badge
                                                    @(report.FileType == "PDF" ? "bg-danger" :
                                                      report.FileType == "XLSX" ? "bg-success" : "bg-primary")">
                                                    @report.FileType
                                                </span>
                                            </td>
                                            <td>@report.CreatedDate.ToString("yyyy-MM-dd HH:mm")</td>
                                            <td>@report.FileSizeFormatted</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="@Url.Action("DownloadReport", new { fileName = report.FileName })"
                                                       class="btn btn-outline-primary">
                                                        📥 Download
                                                    </a>
                                                    @using (Html.BeginForm("DeleteReport", "Reports", FormMethod.Post, new { @class = "d-inline" }))
                                                    {
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="fileName" value="@report.FileName" />
                                                        <button type="submit" class="btn btn-outline-danger"
                                                                onclick="return confirm('Are you sure you want to delete this report?')">
                                                            🗑️ Delete
                                                        </button>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info text-center">
                            <h5>No Saved Reports</h5>
                            <p>Export a report to see it appear in the archive.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .table th {
        font-size: 0.85rem;
        font-weight: 600;
    }

    .table td {
        font-size: 0.8rem;
    }

    .card {
        border: none;
        border-radius: 10px;
    }

    .card-header {
        border-radius: 10px 10px 0 0 !important;
    }

    .btn-group .btn {
        margin-right: 5px;
    }

    .chart-container {
        position: relative;
        height: 250px;
        width: 100%;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Sample data for charts - in a real application, this would come from the controller
        const stockByCategoryData = {
            labels: ['Mountain Bikes', 'Road Bikes', 'Cruisers', 'BMX Bikes', 'City Bikes'],
            datasets: [{
                data: [12, 19, 8, 5, 7],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF'
                ]
            }]
        };

        const topProductsData = {
            labels: ['Trek Speedster', 'Electra Cruiser', 'Haro BMX Pro', 'Pure Cycles Urban', 'Surly Mountain'],
            datasets: [{
                label: 'Units Sold',
                data: [65, 59, 80, 81, 56],
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        };

        const brandPerformanceData = {
            labels: ['Trek', 'Electra', 'Haro', 'Pure Cycles', 'Surly'],
            datasets: [{
                label: 'Revenue (R)',
                data: [125000, 98000, 76000, 54000, 32000],
                backgroundColor: 'rgba(153, 102, 255, 0.6)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1
            }]
        };

        const priceStockData = {
            datasets: [{
                label: 'Products',
                data: [
                    { x: 1200, y: 5 },
                    { x: 450, y: 3 },
                    { x: 350, y: 8 },
                    { x: 800, y: 2 },
                    { x: 1500, y: 1 },
                    { x: 600, y: 6 },
                    { x: 950, y: 4 }
                ],
                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }]
        };

        // Initialize charts
        new Chart(document.getElementById('stockByCategoryChart'), {
            type: 'pie',
            data: stockByCategoryData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: true,
                        text: 'Stock Distribution by Category'
                    }
                }
            }
        });

        new Chart(document.getElementById('topProductsChart'), {
            type: 'bar',
            data: topProductsData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Top 5 Selling Products'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Units Sold'
                        }
                    }
                }
            }
        });

        new Chart(document.getElementById('brandPerformanceChart'), {
            type: 'bar',
            data: brandPerformanceData,
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Revenue by Brand'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return 'R ' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        new Chart(document.getElementById('priceStockChart'), {
            type: 'scatter',
            data: priceStockData,
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Price vs Stock Quantity'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Price (R)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Stock Quantity'
                        }
                    }
                }
            }
        });
    });
</script>